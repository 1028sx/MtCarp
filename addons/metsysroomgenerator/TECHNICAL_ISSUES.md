# MetSys Room Generator - 技術問題記錄

## 項目狀態：暫停開發

**暫停原因**：遇到 Godot 4.3 插件環境中的 GDScript 載入和實例化問題

---

## 核心問題

### 主要錯誤
```
Invalid call. Nonexistent function 'new' in base 'GDScript'
錯誤位置：dock_ui.gd:630-644 (實例化外部腳本時)
```

### 問題描述
在 EditorPlugin 環境中載入外部 GDScript 文件並實例化時出現錯誤。具體表現為：
1. `load()` 和 `preload()` 都能成功載入腳本
2. 但調用 `ScriptClass.new()` 時報錯 "Nonexistent function 'new'"
3. 程序在實例化步驟卡死

### 受影響的組件
- `tilemap_builder.gd` - TileMap 生成器
- `scene_template_creator.gd` - 場景模板創建器

---

## 已嘗試的解決方案

### 1. 載入方式優化
**嘗試**：
- 使用 `load()` 替代直接引用
- 使用 `preload()` 替代 `load()`
- 添加腳本存在性檢查

**結果**：腳本載入成功，但實例化仍失敗

### 2. 實例化方式調整
**嘗試**：
- 直接調用 `ScriptClass.new()`
- 檢查載入的對象類型
- 添加詳細的錯誤捕獲

**結果**：載入的對象確實是 GDScript，但 `.new()` 方法不存在

### 3. 異步處理優化
**嘗試**：
- 移除 `await get_tree().process_frame`
- 改為同步處理避免卡死
- 添加逐步執行的調試日誌

**結果**：解決了一些卡死問題，但核心實例化問題依舊

### 4. 內聯實現替代
**嘗試**：
- 將 TileMap 和場景生成邏輯直接寫在 dock_ui.gd 中
- 避免外部腳本載入問題

**結果**：可以工作，但代碼結構不佳，維護性差

---

## 當前功能狀態

### ✅ 可用功能
- **顏色掃描**：自動檢測 MapData.txt 中的所有顏色
- **區域配置**：為每個顏色設置區域名稱
- **TileSet 選擇**：完整的文件瀏覽和路徑輸入
- **瓦片選擇**：為地板、牆壁、天花板、背景選擇不同瓦片
- **房間模板**：模板文件瀏覽和選擇
- **配置管理**：自動保存和載入所有設置
- **UI 界面**：完整的停靠面板界面

### ❌ 不可用功能
- **房間生成**：由於腳本載入問題暫時停用
- **TileMap 創建**：依賴外部腳本，無法使用
- **場景文件生成**：核心功能受阻

---

## 可能的解決方向

### 1. 腳本架構重構
**方案**：
- 將所有邏輯移至 dock_ui.gd 內部
- 使用類方法而非外部腳本
- 重新設計模組化結構

**優點**：避免載入問題，可立即使用
**缺點**：代碼結構複雜，維護困難

### 2. 插件載入機制研究
**方案**：
- 深入研究 Godot 4.3 EditorPlugin 腳本載入機制
- 查找官方文檔或社區解決方案
- 測試不同的載入和實例化方式

**優點**：解決根本問題，保持良好架構
**缺點**：需要時間研究，不確定是否有解

### 3. 工具腳本化
**方案**：
- 將生成邏輯改為 @tool 腳本
- 使用場景載入而非腳本實例化
- 通過信號或自動載入機制通信

**優點**：可能繞過載入問題
**缺點**：需要重新設計架構

### 4. 混合方案
**方案**：
- 保留當前的配置和UI功能
- 核心生成邏輯使用單獨的工具或外部程序
- 通過文件交換數據

**優點**：UI功能完整，生成功能獨立
**缺點**：用戶體驗較差，需要額外工具

---

## 技術細節記錄

### GDScript 載入問題分析
```gdscript
# 這樣載入成功
var ScriptClass = preload("res://path/to/script.gd")
print(ScriptClass)  # 輸出：<GDScript#-9223372008424121340>

# 但這樣失敗
var instance = ScriptClass.new()  # 錯誤：Nonexistent function 'new'
```

### 可能的根因
1. **插件環境限制**：EditorPlugin 可能對腳本實例化有特殊限制
2. **Godot 4.3 變更**：新版本可能改變了插件腳本載入機制
3. **依賴問題**：外部腳本可能有未滿足的依賴
4. **@tool 標注問題**：工具腳本的載入機制可能不同

### 測試環境
- Godot 版本：4.3 stable
- 操作系統：Windows
- 項目類型：2D 遊戲項目
- 插件位置：`addons/metsysroomgenerator/`

---

## 推薦後續行動

### 短期方案
1. 保持當前配置功能可用
2. 在 UI 中明確標示生成功能暫時不可用
3. 提供手動替代方案的文檔

### 長期方案
1. 研究 Godot 4.3 插件開發最佳實踐
2. 查找類似問題的社區解決方案
3. 考慮聯繫 Godot 開發社區獲得支持
4. 評估是否需要降級到 Godot 4.2 或更早版本

---

## 相關文件

### 主要組件
- `plugin.gd` - 插件入口點
- `dock_ui.gd` - 主要UI和邏輯（可用）
- `room_generator.gd` - 房間掃描邏輯（可用）
- `config_manager.gd` - 配置管理（可用）
- `tilemap_builder.gd` - TileMap 生成（有問題）
- `scene_template_creator.gd` - 場景創建（有問題）

### 配置文件
- `plugin.cfg` - 插件配置
- `metsys_room_generator_config.json` - 用戶配置（自動生成）

---

*文檔更新時間：2024年（當前日期）*
*狀態：開發暫停，問題調查中*